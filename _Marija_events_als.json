{"paragraphs":[{"title":"Ucitavanje biblioteka","text":"%spark2.pyspark\nfrom pyspark.sql.functions import col, explode\nfrom pyspark.sql.functions import collect_list","dateUpdated":"2019-01-22T15:17:19+0100","config":{"editorSetting":{"language":"python"},"colWidth":12,"editorMode":"ace/mode/python","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1548166639211_1570774162","id":"20180901-163007_804557861","dateCreated":"2019-01-22T15:17:19+0100","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:6115"},{"title":"Ucitavanje tabele rejtinga","text":"%spark2.pyspark\n\nratings = spark.read.csv('ratings_events.csv',sep=',',inferSchema=True, header=True)","dateUpdated":"2019-01-22T15:17:19+0100","config":{"editorSetting":{"language":"python"},"colWidth":12,"editorMode":"ace/mode/python","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1548166639212_1568850418","id":"20180901-132920_1627893841","dateCreated":"2019-01-22T15:17:19+0100","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6116"},{"title":"Deljenje rejtinga na training i test set","text":"%spark2.pyspark\nratings = ratings.withColumn(\"rnd_\", F.rand())\nw = Window.partitionBy(F.col(\"visitorid\")).orderBy(F.col(\"visitorid\"),F.col(\"rnd_\"))\n\ntest = (ratings\n    .withColumn(\"rn_\", F.row_number().over(w))  # Add rowNumber over windw\n    .where(F.col(\"rn_\") == 1)  # Take n observations\n    .drop(\"rn_\")  # drop helper columns\n    )\n\ntraining = ratings.alias(\"a\").join(test.alias(\"b\"), F.col('a.rnd_') == F.col('b.rnd_') , 'left_anti')","dateUpdated":"2019-01-22T15:17:19+0100","config":{"editorSetting":{"language":"python"},"colWidth":12,"editorMode":"ace/mode/python","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1548166639212_1568850418","id":"20180901-133101_2044236822","dateCreated":"2019-01-22T15:17:19+0100","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6117"},{"title":"Preimenovanje kolona i kreiranje RDD test seta","text":"%spark2.pyspark\ntest = test.withColumn(\"rank\", F.dense_rank().over(Window.partitionBy(\"visitorid\").orderBy(F.desc(\"rating\"))))\ntest = test.withColumnRenamed(\"rank\", \"rank_t\")\ntestRDD = test.select(\"visitorid\", \"itemid\", \"rank_t\").rdd","dateUpdated":"2019-01-22T15:17:19+0100","config":{"editorSetting":{"language":"python"},"colWidth":12,"editorMode":"ace/mode/python","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1548166639212_1568850418","id":"20180901-163125_15903996","dateCreated":"2019-01-22T15:17:19+0100","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6118"},{"title":"Funkcija za pokretanje ALS-a","text":"%spark2.pyspark\ndef run_als(training,test,ra,reg,al):\n        als = ALS(regParam=reg, rank = ra, alpha = al, nonnegative=True, coldStartStrategy=\"drop\",userCol=\"visitorid\", itemCol=\"itemid\", ratingCol=\"rating\", seed = 12345, implicitPrefs=True)\n        model = als.fit(training)\n        prodRecs = model.recommendForAllUsers(20)\n        prodRecs = prodRecs.withColumn(\"recommendations\", explode(\"recommendations\")).select(\"*\", col(\"recommendations\")[\"itemid\"].alias(\"itemid\"),col(\"recommendations\")[\"rating\"].alias(\"rating\")).select(\"visitorid\", \"itemid\", \"rating\")\n        prodRecs = prodRecs.withColumn(\"rank\", F.dense_rank().over(Window.partitionBy(\"visitorid\").orderBy(F.desc(\"rating\"))))\n        prodRecs = prodRecs.withColumnRenamed(\"rank\", \"rank_p\")\n        recsRDD = prodRecs.select(\"visitorid\", \"itemid\", \"rank_p\").rdd\n        predictions = recsRDD.map(lambda r: ((r.visitorid, r.itemid), r.rank_p))\n        tests = testRDD.map(lambda r: ((r.visitorid, r.itemid), r.rank_t))\n        scoreAndLabels = predictions.join(tests)\n        df = scoreAndLabels.toDF()\n        df_ranks = df.select(df[\"_1\"].getItem(\"_1\").alias(\"visitorid\"), \n        df[\"_1\"].getItem(\"_2\").alias(\"itemid\"), \n        df[\"_2\"].getItem(\"_1\").alias(\"rank_p\"),\n        df[\"_2\"].getItem(\"_2\").alias(\"rank_t\"))\n        grouped_ranks = df_ranks.groupby('visitorid').agg(collect_list('rank_p').alias(\"rank_p\"),collect_list('rank_t').alias(\"rank_t\"))\n        grouped_ranks = grouped_ranks.withColumn(\"ranks\",F.array(col(\"rank_p\"), col(\"rank_t\")))\n        ranks = grouped_ranks.select(\"ranks\")\n        rank = ranks.select(\"ranks\").rdd.flatMap(lambda x: x)\n        metrics = RankingMetrics(rank)\n        ndcgAt10 = metrics.ndcgAt(10)\n        meanAvgPrec = metrics.meanAveragePrecision\n        precAt10 = metrics.precisionAt(10)\n        print(\"NDCG at 10 = \"+str(ndcgAt10)+\", Mean Average Precision = \"+str(meanAvgPrec)+\", Precision at 10 = \"+str(precAt10))","dateUpdated":"2019-01-22T15:17:19+0100","config":{"editorSetting":{"language":"python"},"colWidth":12,"editorMode":"ace/mode/python","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1548166639212_1568850418","id":"20180901-184252_403627178","dateCreated":"2019-01-22T15:17:19+0100","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6119"},{"title":"Variranje parametra rank","text":"%spark2.pyspark\n\nfor param in [10, 20, 50, 100, 500]:\n        print(\"For rank = \"+str(param)+\": \")\n        run_als(training,test,param,0.1,1.0)\n        ","dateUpdated":"2019-01-22T15:17:19+0100","config":{"editorSetting":{"language":"python"},"colWidth":12,"editorMode":"ace/mode/python","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"For rank = 10: \nNDCG at 10 = 0.13439110448, Mean Average Precision = 0.128377534127, Precision at 10 = 0.0167838065786\nFor rank = 20: \nNDCG at 10 = 0.177272111047, Mean Average Precision = 0.168838742859, Precision at 10 = 0.0234749545379\nFor rank = 50: \nNDCG at 10 = 0.193231693465, Mean Average Precision = 0.181554322656, Precision at 10 = 0.0254783412761\nFor rank = 100: \nNDCG at 10 = 0.20245040661, Mean Average Precision = 0.189498998099, Precision at 10 = 0.0273234629399\nFor rank = 500: \nNDCG at 10 = 0.2268533039, Mean Average Precision = 0.2085484432, Precision at 10 = 0.0324133953948\n"}]},"apps":[],"jobName":"paragraph_1548166639212_1568850418","id":"20180901-134836_1543915083","dateCreated":"2019-01-22T15:17:19+0100","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6120"},{"title":"Variranje parametra alpha","text":"%spark2.pyspark\n\nfor param in [1.0, 5.0, 10.0, 20.0, 50.0]:\n        print(\"For alpha = \"+str(param)+\": \")\n        run_als(training,test,10,0.1,param)\n        \n\n","dateUpdated":"2019-01-22T15:17:19+0100","config":{"editorSetting":{"language":"python"},"colWidth":12,"editorMode":"ace/mode/python","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"For alpha = 1.0: \nNDCG at 10 = 0.180482220421, Mean Average Precision = 0.172391989745, Precision at 10 = 0.0243841596508\nFor alpha = 5.0: \nNDCG at 10 = 0.143737441597, Mean Average Precision = 0.137969441454, Precision at 10 = 0.0181108719053\nFor alpha = 10.0: \nNDCG at 10 = 0.191901526139, Mean Average Precision = 0.187918418185, Precision at 10 = 0.0223960765997\nFor alpha = 20.0: \nNDCG at 10 = 0.130168803303, Mean Average Precision = 0.125891235995, Precision at 10 = 0.0157632522917\nFor alpha = 50.0: \nNDCG at 10 = 0.146882557706, Mean Average Precision = 0.143017500893, Precision at 10 = 0.0174651767947\n"}]},"apps":[],"jobName":"paragraph_1548166639212_1568850418","id":"20180903-143023_115883268","dateCreated":"2019-01-22T15:17:19+0100","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6121"},{"title":"Variranje regularizacionog parametera","text":"%spark2.pyspark\n\nfor param in [0.001, 0.01, 0.1, 1.0, 2.0]:\n        print(\"For regularization parameter = \"+str(param)+\": \")\n        run_als(training,test,10,param,1.0)\n        ","dateUpdated":"2019-01-22T15:17:19+0100","config":{"editorSetting":{"language":"python"},"colWidth":12,"editorMode":"ace/mode/python","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"For regularization parameter = 0.001: \nNDCG at 10 = 0.231204940955, Mean Average Precision = 0.223125614553, Precision at 10 = 0.0292477876106\nFor regularization parameter = 0.01: \nNDCG at 10 = 0.189839044103, Mean Average Precision = 0.182147447132, Precision at 10 = 0.0232597266036\nFor regularization parameter = 0.1: \nNDCG at 10 = 0.129671323118, Mean Average Precision = 0.122145881047, Precision at 10 = 0.0178638351031\nFor regularization parameter = 1.0: \nNDCG at 10 = 0.147259503354, Mean Average Precision = 0.139989553018, Precision at 10 = 0.0177300201478\nFor regularization parameter = 2.0: \nNDCG at 10 = 0.0465857600007, Mean Average Precision = 0.0463590177815, Precision at 10 = 0.0047417442845\n"}]},"apps":[],"jobName":"paragraph_1548166639212_1568850418","id":"20180901-184642_2000048708","dateCreated":"2019-01-22T15:17:19+0100","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6122"},{"title":"ALS sa optimalnim parametrima","text":"%spark2.pyspark\n\nrun_als(training,test,100.0,0.001,10.0)","dateUpdated":"2019-01-22T15:17:19+0100","config":{"editorSetting":{"language":"python"},"colWidth":12,"editorMode":"ace/mode/python","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"NDCG at 10 = 0.236735136441, Mean Average Precision = 0.231149786316, Precision at 10 = 0.0269647861582\n"}]},"apps":[],"jobName":"paragraph_1548166639212_1568850418","id":"20180904-101544_551588369","dateCreated":"2019-01-22T15:17:19+0100","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6123"},{"text":"%spark2.pyspark\n#uticaj rank-a na als\nrun_als(training,test,100.0,0.1,1.0)","dateUpdated":"2019-01-22T15:17:19+0100","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"NDCG at 10 = 0.198648176106, Mean Average Precision = 0.185816901123, Precision at 10 = 0.0269711056421\n"}]},"apps":[],"jobName":"paragraph_1548166639213_1568465669","id":"20180906-221823_931921925","dateCreated":"2019-01-22T15:17:19+0100","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6124"},{"text":"%spark2.pyspark\n#uticaj regParam-a na als\nrun_als(training,test,10.0,0.001,1.0)","dateUpdated":"2019-01-22T15:17:19+0100","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"NDCG at 10 = 0.219276027442, Mean Average Precision = 0.212559435256, Precision at 10 = 0.0265686531898\n"}]},"apps":[],"jobName":"paragraph_1548166639213_1568465669","id":"20180906-221900_1240306843","dateCreated":"2019-01-22T15:17:19+0100","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6125"},{"text":"%spark2.pyspark\n#uticaj alpha-e na als\nrun_als(training,test,10.0,0.1,10.0)","dateUpdated":"2019-01-22T15:17:19+0100","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"NDCG at 10 = 0.154389015666, Mean Average Precision = 0.150962161162, Precision at 10 = 0.0178601165695\n"}]},"apps":[],"jobName":"paragraph_1548166639213_1568465669","id":"20180906-221924_2103304355","dateCreated":"2019-01-22T15:17:19+0100","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6126"},{"title":"ALS sa podrazumevanim parametrima","text":"%spark2.pyspark\n\nrun_als(training,test,10,0.1,1.0)","dateUpdated":"2019-01-22T15:17:19+0100","config":{"editorSetting":{"language":"python"},"colWidth":12,"editorMode":"ace/mode/python","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"NDCG at 10 = 0.160171131546, Mean Average Precision = 0.152616653777, Precision at 10 = 0.0212587006961\n"}]},"apps":[],"jobName":"paragraph_1548166639213_1568465669","id":"20180904-105319_633584971","dateCreated":"2019-01-22T15:17:19+0100","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6127"},{"text":"%spark2.pyspark\n","dateUpdated":"2019-01-22T15:17:19+0100","config":{"colWidth":12,"editorMode":"ace/mode/python","results":{},"enabled":true,"editorSetting":{"language":"python"}},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1548166639213_1568465669","id":"20180904-220524_1665409713","dateCreated":"2019-01-22T15:17:19+0100","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:6128"}],"name":"/Marija/events_als","id":"2E43NCSTG","angularObjects":{"2CHS8UYQQ:shared_process":[],"2C4U48MY3_spark2::2E43NCSTG":[],"2DJR44AWX:shared_process":[],"2DS5MUA22:shared_process":[],"2CK8A9MEG:shared_process":[],"2CKX8WPU1:shared_process":[],"2CKAY1A8Y:shared_process":[],"2CKEKWY8Z:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":true,"looknfeel":"default","personalizedMode":"false"},"info":{}}